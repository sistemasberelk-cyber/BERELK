{% extends "base.html" %}

{% block title %}Picking (v2.5) - NexPos{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto; padding-bottom: 80px;">

    <!-- Mode Selection -->
    <div id="mode-selector" style="display: flex; flex-direction: column; gap: 24px; padding-top: 40px;">
        <button onclick="setMode('entry')" class="mode-btn entry">
            <div style="font-size: 3rem;">üì•</div>
            <h2>ENTRADA</h2>
            <p>Ingreso de Mercader√≠a</p>
        </button>

        <button onclick="setMode('exit')" class="mode-btn exit">
            <div style="font-size: 3rem;">üì§</div>
            <h2>SALIDA</h2>
            <p>Facturaci√≥n R√°pida</p>
        </button>
    </div>

    <!-- Active Mode UI (Hidden initially) -->
    <div id="active-mode" style="display: none;">
        <!-- Header -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <button onclick="resetMode()" class="btn"
                style="background: transparent; color: #666; border: 1px solid #ccc;">‚¨Ö Volver</button>
            <h3 id="mode-title" style="margin: 0;">MODO</h3>
        </div>

        <!-- Scanner View -->
        <div class="glass-card"
            style="padding: 12px; margin-bottom: 16px; background: black; overflow: hidden; border-radius: 16px;">
            <div id="reader" style="width: 100%; min-height: 250px;"></div>
        </div>

        <!-- Quantity Control -->
        <div class="glass-card"
            style="margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 16px; padding: 12px;">
            <span style="font-weight: bold; color: #666;">Cantidad:</span>
            <button onclick="adjustQty(-1)" class="btn"
                style="width: 40px; height: 40px; padding: 0; background: #e2e8f0; color: black;">-</button>
            <input type="number" id="picking-qty" value="1" min="1"
                style="width: 60px; text-align: center; font-size: 1.2rem; padding: 8px; border: 1px solid #ccc; border-radius: 8px;">
            <button onclick="document.getElementById('picking-qty').stepUp()" class="btn"
                style="width: 40px; height: 40px; padding: 0; background: #e2e8f0; color: black;">+</button>

            <!-- Manual Enter Button -->
            <button onclick="manualEnter()" class="btn"
                style="height: 40px; padding: 0 16px; background: #2563eb; color: white;">
                ‚èé
            </button>
        </div>

        <!-- Last Action Log / Cart -->
        <div id="action-log" class="glass-card" style="min-height: 100px;">
            <p style="color: #64748b; text-align: center; margin-top: 32px;">Escanea un c√≥digo de barras...</p>
        </div>

        <!-- Checkout Button (Only for Exit) -->
        <div id="checkout-container"
            style="display: none; position: fixed; bottom: 80px; left: 0; width: 100%; padding: 16px; text-align: center;">
            <button onclick="processCheckout()" class="btn"
                style="width: 90%; max-width: 500px; padding: 16px; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                üñ®Ô∏è IMPRIMIR FACTURA
            </button>
        </div>
    </div>

</div>

<!-- Audio for feedback -->
<!-- Beep sound usage logic in JS -->

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    let currentMode = null; // 'entry' or 'exit'
    let html5QrcodeScanner = null;
    let scannedItems = []; // For Exit mode cart

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-selector').style.display = 'none';
        document.getElementById('active-mode').style.display = 'block';

        const title = document.getElementById('mode-title');
        const log = document.getElementById('action-log');

        if (mode === 'entry') {
            title.innerText = "ENTRADA DE PRODUCTOS";
            title.style.color = "#10b981";
            log.innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 32px;">Escanea para sumar stock (+1)...</p>';
            document.getElementById('checkout-container').style.display = 'none';
        } else {
            title.innerText = "SALIDA (FACTURACI√ìN)";
            title.style.color = "#ef4444";
            log.innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 32px;">Escanea para agregar al pedido...</p>';
            // Show checkout button only if we have items? Or always? Let's hide until scan
            document.getElementById('checkout-container').style.display = 'block';
            scannedItems = [];
        }

        startScanner();
    }

    function resetMode() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(err => console.error("Failed to clear scanner", err));
            html5QrcodeScanner = null;
        }
        document.getElementById('active-mode').style.display = 'none';
        document.getElementById('mode-selector').style.display = 'flex';
        currentMode = null;
    }

    // --- HYBRID SCANNER LOGIC (PICKING VERSION) ---
    let nativeStream = null;

    function startScanner() {
        // Clear previous instances
        if (html5QrcodeScanner) { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }
        if (nativeStream) { nativeStream.getTracks().forEach(t => t.stop()); nativeStream = null; }

        const readerDiv = document.getElementById('reader');
        readerDiv.innerHTML = '<div style="padding:20px; text-align:center;">üîÑ Iniciando Esc√°ner...</div>';

        // A. CHECK FOR GOOGLE NATIVE BARCODE API
        if ('BarcodeDetector' in window) {
            console.log("üöÄ Picking: Usando Google Native API");
            startNativeScanner(readerDiv);
        } else {
            console.log("‚ö†Ô∏è Picking: Usando Legacy Lib");
            startLegacyScanner();
        }
    }

    async function startNativeScanner(container) {
        try {
            // 1. Setup Video Element (INLINE, CENTERED)
            container.innerHTML = `
                <div style="position: relative; width: 100%; height: 300px; background: black; display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 12px;">
                    <video id="native-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
                    
                    <!-- HUD Overlay -->
                    <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px; z-index: 10;">
                        ‚ö° Google ML (Picking)
                    </div>
                </div>
                <div style="text-align: center; margin-top: 8px; color: #666; font-size: 0.9rem;">C√°mara activa - Escanea continuadamente</div>
            `;
            const video = document.getElementById('native-video');

            // 2. Get Camera Stream
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { exact: "environment" } }
            }).catch(() => navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }));

            nativeStream = stream;
            video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r);

            // 3. Init Detector
            const formats = ['ean_13', 'code_128', 'qr_code', 'ean_8', 'upc_a', 'upc_e', 'codabar', 'itf'];
            let barcodeDetector;
            try {
                barcodeDetector = new BarcodeDetector({ formats: formats });
            } catch (e) {
                barcodeDetector = new BarcodeDetector();
            }

            // 4. Scan Loop
            const scanLoop = async () => {
                if (!nativeStream) return;
                try {
                    const barcodes = await barcodeDetector.detect(video);
                    if (barcodes.length > 0) {
                        const code = barcodes[0].rawValue;
                        console.log("üî´ Picking Scan:", code);

                        // Visual Feedback
                        const feedback = document.createElement("div");
                        feedback.innerHTML = `‚úÖ ${code}`;
                        feedback.style.cssText = "position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 6px 12px; border-radius: 20px; font-weight:bold; z-index: 20; box-shadow: 0 2px 8px rgba(0,0,0,0.3);";
                        container.querySelector('div').appendChild(feedback);
                        setTimeout(() => feedback.remove(), 1000);

                        onScanSuccess(code, null);
                        if (navigator.vibrate) navigator.vibrate(50);
                        await new Promise(r => setTimeout(r, 1200)); // Slower debounce for picking
                    }
                } catch (e) { }
                if (nativeStream) requestAnimationFrame(scanLoop);
            };
            scanLoop();

        } catch (err) {
            console.error("Native Picking failed:", err);
            container.innerHTML = `<div style="color:red; padding:20px;">Error c√°mara: ${err.message}</div>`;
            setTimeout(startLegacyScanner, 2000);
        }
    }

    function startLegacyScanner() {
        if (html5QrcodeScanner === null) {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader",
                {
                    fps: 15, qrbox: { width: 300, height: 150 },
                    aspectRatio: 1.0,
                    formatsToSupport: [Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.CODE_128],
                    videoConstraints: { facingMode: "environment" }
                },
                false
            );
        }
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    // Debounce scan
    let isProcessing = false;

    async function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing) return;
        isProcessing = true;

        // Clean AIM identifiers
        let cleanCode = decodedText.trim();
        cleanCode = cleanCode.replace(/^\][A-Za-z]\d/, '');
        if (cleanCode.startsWith(']')) cleanCode = cleanCode.substring(cleanCode.indexOf(']') + 1);

        console.log(`Scan: ${cleanCode} (Raw: ${decodedText})`);
        if (navigator.vibrate) navigator.vibrate(50);

        // Prompt for Quantity
        const modeTitle = currentMode === 'entry' ? 'Entrada de Stock' : 'Salida de Mercader√≠a';

        try {
            // Pause scanner visually if possible or just rely on overlay
            const { value: inputQty, isConfirmed } = await Swal.fire({
                title: modeTitle,
                html: `Producto detectado: <b>${cleanCode}</b><br>Ingrese cantidad:`,
                input: 'number',
                inputValue: 1,
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Cancelar',
                inputAttributes: {
                    min: 1,
                    step: 1
                },
                didOpen: () => {
                    const input = Swal.getInput();
                    input.select();
                }
            });

            if (isConfirmed && inputQty) {
                const qty = parseInt(inputQty);
                document.getElementById('picking-qty').value = qty;

                if (currentMode === 'entry') {
                    await handleEntry(cleanCode);
                } else {
                    await handleExit(cleanCode);
                }
            }
        } catch (e) {
            console.error("Error in prompt:", e);
        }

        // Wait a bit before next scan to prevent double scans
        setTimeout(() => { isProcessing = false; }, 1000);
    }

    function onScanFailure(error) {
        // quiet
    }

    // --- Logic ---

    function adjustQty(delta) {
        const input = document.getElementById('picking-qty');
        let val = parseInt(input.value) || 1;
        val += delta;
        if (val < 1) val = 1;
        input.value = val;
    }

    async function handleEntry(barcode) {
        const log = document.getElementById('action-log');
        const qty = parseInt(document.getElementById('picking-qty').value) || 1;

        try {
            const formData = new FormData();
            formData.append('barcode', barcode);
            formData.append('qty', qty);

            const res = await fetch('/api/picking/entry', { method: 'POST', body: formData });
            const data = await res.json();

            if (res.ok) {
                // Prepend log
                const itemHtml = `
                    <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px; margin-bottom: 8px; border-radius: 4px;">
                        <div style="font-weight: bold;">${data.product.name}</div>
                        <div style="font-size: 0.9rem;">Stock actualizado: <b>${data.product.new_stock}</b> (+${qty})</div>
                    </div>
                `;
                if (log.innerHTML.includes("Escanea")) log.innerHTML = "";
                log.insertAdjacentHTML('afterbegin', itemHtml);
            } else {
                alert("Error: " + (data.detail || "No encontrado"));
            }
        } catch (e) {
            alert("Error de conexi√≥n");
        }
    }

    async function handleExit(barcode) {
        const log = document.getElementById('action-log');
        const qty = parseInt(document.getElementById('picking-qty').value) || 1;

        try {
            // Add to cart
            scannedItems.push({ barcode: barcode, qty: qty });

            const itemHtml = `
                    <div style="background: #fff1f2; border-left: 4px solid #ef4444; padding: 12px; margin-bottom: 8px; border-radius: 4px;">
                        <div style="font-weight: bold;">Producto (Code: ${barcode})</div>
                        <div style="font-size: 0.9rem;">Agregado a la salida (x${qty})</div>
                    </div>
                `;
            if (log.innerHTML.includes("Escanea")) log.innerHTML = "";
            log.insertAdjacentHTML('afterbegin', itemHtml);

        } catch (e) { console.error(e) }
    }

    async function processCheckout() {
        if (scannedItems.length === 0) {
            alert("No hay productos escaneados.");
            return;
        }

        if (!confirm("¬øConfirmar Salida e Imprimir Factura?")) return;

        try {
            const res = await fetch('/api/picking/exit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: scannedItems })
            });

            const data = await res.json();

            if (res.ok) {
                alert("Factura Generada #" + data.sale_id);
                // Reset
                scannedItems = [];
                document.getElementById('action-log').innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 32px;">Pedido finalizado. Escanea para nuevo...</p>';
                // Trigger Print (New Tab / Window)
                if (data.print_url) {
                    window.open(data.print_url, '_blank');
                }
            } else {
                alert("Error: " + (data.detail || "Desconocido"));
            }
        } catch (e) {
            alert("Error de conexi√≥n");
        }
    }

    function manualEnter() {
        const code = prompt("Ingrese C√≥digo de Barras / ID Manualmente:");
        if (code && code.trim()) {
            onScanSuccess(code.trim(), null);
        }
    }

</script>

<style>
    .mode-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        border: none;
        border-radius: 24px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .mode-btn:active {
        transform: scale(0.98);
    }

    .mode-btn h2 {
        margin: 16px 0 8px 0;
    }

    .mode-btn p {
        margin: 0;
        color: #666;
    }

    .entry {
        border-bottom: 6px solid #10b981;
    }

    .exit {
        border-bottom: 6px solid #ef4444;
    }

    /* Override base container for full width feel on mobile */
    .container {
        padding: 16px;
    }
</style>
{% endblock %}