{% extends "base.html" %}

{% block title %}Picking (v2.5) - NexPos{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto; padding-bottom: 80px;">

    <!-- Mode Selection -->
    <div id="mode-selector" style="display: flex; flex-direction: column; gap: 24px; padding-top: 40px;">
        <button onclick="setMode('entry')" class="mode-btn entry">
            <div style="font-size: 3rem;">üì•</div>
            <h2>ENTRADA</h2>
            <p>Ingreso de Mercader√≠a</p>
        </button>

        <button onclick="setMode('exit')" class="mode-btn exit">
            <div style="font-size: 3rem;">üì§</div>
            <h2>SALIDA</h2>
            <p>Facturaci√≥n R√°pida</p>
        </button>
    </div>

    <!-- Active Mode UI (Hidden initially) -->
    <div id="active-mode" style="display: none;">
        <!-- Header -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
            <button onclick="resetMode()" class="btn"
                style="background: transparent; color: #666; border: 1px solid #ccc;">‚¨Ö Volver</button>
            <h3 id="mode-title" style="margin: 0;">MODO</h3>
        </div>

        <!-- Scanner View -->
        <div class="glass-card"
            style="padding: 12px; margin-bottom: 16px; background: black; overflow: hidden; border-radius: 16px;">
            <div id="reader" style="width: 100%; min-height: 250px;"></div>
        </div>

        <!-- Quantity Control -->
        <div class="glass-card"
            style="margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 16px; padding: 12px;">
            <span style="font-weight: bold; color: #666;">Cantidad:</span>
            <button onclick="adjustQty(-1)" class="btn"
                style="width: 40px; height: 40px; padding: 0; background: #e2e8f0; color: black;">-</button>
            <input type="number" id="picking-qty" value="1" min="1"
                style="width: 60px; text-align: center; font-size: 1.2rem; padding: 8px; border: 1px solid #ccc; border-radius: 8px;">
            <button onclick="document.getElementById('picking-qty').stepUp()" class="btn"
                style="width: 40px; height: 40px; padding: 0; background: #e2e8f0; color: black;">+</button>

            <!-- Manual Enter Button -->
            <button onclick="manualEnter()" class="btn"
                style="height: 40px; padding: 0 16px; background: #2563eb; color: white;">
                ‚èé
            </button>
        </div>

        <!-- Last Action Log / Cart -->
        <div id="action-log" class="glass-card" style="min-height: 100px;">
            <p style="color: #64748b; text-align: center; margin-top: 32px;">Escanea un c√≥digo de barras...</p>
        </div>

        <!-- Checkout Button (Only for Exit) -->
        <div id="checkout-container"
            style="display: none; position: fixed; bottom: 80px; left: 0; width: 100%; padding: 16px; text-align: center;">
            <button onclick="processCheckout()" class="btn"
                style="width: 90%; max-width: 500px; padding: 16px; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                üñ®Ô∏è IMPRIMIR FACTURA
            </button>
        </div>
    </div>

</div>

<!-- Audio for feedback -->
<!-- Beep sound usage logic in JS -->

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    let currentMode = null; // 'entry' or 'exit'
    let html5QrcodeScanner = null;
    let scannedItems = []; // For Exit mode cart

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('mode-selector').style.display = 'none';
        document.getElementById('active-mode').style.display = 'block';

        const title = document.getElementById('mode-title');
        const log = document.getElementById('action-log');

        if (mode === 'entry') {
            title.innerText = "ENTRADA DE PRODUCTOS";
            title.style.color = "#10b981";
            log.innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 32px;">Escanea para sumar stock (+1)...</p>';
            document.getElementById('checkout-container').style.display = 'none';
        } else {
            title.innerText = "SALIDA (FACTURACI√ìN)";
            title.style.color = "#ef4444";
            log.innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 32px;">Escanea para agregar al pedido...</p>';
            // Show checkout button only if we have items? Or always? Let's hide until scan
            document.getElementById('checkout-container').style.display = 'block';
            scannedItems = [];
        }

        startScanner();
    }

    function resetMode() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(err => console.error("Failed to clear scanner", err));
            html5QrcodeScanner = null;
        }
        document.getElementById('active-mode').style.display = 'none';
        document.getElementById('mode-selector').style.display = 'flex';
        currentMode = null;
    }

    function startScanner() {
        if (html5QrcodeScanner === null) {
            html5QrcodeScanner = new Html5QrcodeScanner(
                "reader",
                {
                    fps: 10,
                    qrbox: 250,
                    formatsToSupport: [Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.CODE_128],
                    videoConstraints: { facingMode: "environment" }
                },
                false
            );
        }
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    // Debounce scan
    let isProcessing = false;

    async function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing) return;
        isProcessing = true;

        console.log(`Scan: ${decodedText}`);

        // Visual feedback
        // beep() // Optional

        if (currentMode === 'entry') {
            await handleEntry(decodedText);
        } else {
            await handleExit(decodedText);
        }

        // Wait a bit before next scan to prevent double scans
        setTimeout(() => { isProcessing = false; }, 1500);
    }

    function onScanFailure(error) {
        // quiet
    }

    // --- Logic ---

    function adjustQty(delta) {
        const input = document.getElementById('picking-qty');
        let val = parseInt(input.value) || 1;
        val += delta;
        if (val < 1) val = 1;
        input.value = val;
    }

    async function handleEntry(barcode) {
        const log = document.getElementById('action-log');
        const qty = parseInt(document.getElementById('picking-qty').value) || 1;

        try {
            const formData = new FormData();
            formData.append('barcode', barcode);
            formData.append('qty', qty);

            const res = await fetch('/api/picking/entry', { method: 'POST', body: formData });
            const data = await res.json();

            if (res.ok) {
                // Prepend log
                const itemHtml = `
                    <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px; margin-bottom: 8px; border-radius: 4px;">
                        <div style="font-weight: bold;">${data.product.name}</div>
                        <div style="font-size: 0.9rem;">Stock actualizado: <b>${data.product.new_stock}</b> (+${qty})</div>
                    </div>
                `;
                if (log.innerHTML.includes("Escanea")) log.innerHTML = "";
                log.insertAdjacentHTML('afterbegin', itemHtml);
            } else {
                alert("Error: " + (data.detail || "No encontrado"));
            }
        } catch (e) {
            alert("Error de conexi√≥n");
        }
    }

    async function handleExit(barcode) {
        const log = document.getElementById('action-log');
        const qty = parseInt(document.getElementById('picking-qty').value) || 1;

        try {
            // Add to cart
            scannedItems.push({ barcode: barcode, qty: qty });

            const itemHtml = `
                    <div style="background: #fff1f2; border-left: 4px solid #ef4444; padding: 12px; margin-bottom: 8px; border-radius: 4px;">
                        <div style="font-weight: bold;">Producto (Code: ${barcode})</div>
                        <div style="font-size: 0.9rem;">Agregado a la salida (x${qty})</div>
                    </div>
                `;
            if (log.innerHTML.includes("Escanea")) log.innerHTML = "";
            log.insertAdjacentHTML('afterbegin', itemHtml);

        } catch (e) { console.error(e) }
    }

    async function processCheckout() {
        if (scannedItems.length === 0) {
            alert("No hay productos escaneados.");
            return;
        }

        if (!confirm("¬øConfirmar Salida e Imprimir Factura?")) return;

        try {
            const res = await fetch('/api/picking/exit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: scannedItems })
            });

            const data = await res.json();

            if (res.ok) {
                alert("Factura Generada #" + data.sale_id);
                // Reset
                scannedItems = [];
                document.getElementById('action-log').innerHTML = '<p style="color: #64748b; text-align: center; margin-top: 32px;">Pedido finalizado. Escanea para nuevo...</p>';
                // Trigger Print (New Tab / Window)
                if (data.print_url) {
                    window.open(data.print_url, '_blank');
                }
            } else {
                alert("Error: " + (data.detail || "Desconocido"));
            }
        } catch (e) {
            alert("Error de conexi√≥n");
        }
    }

    function manualEnter() {
        const code = prompt("Ingrese C√≥digo de Barras / ID Manualmente:");
        if (code && code.trim()) {
            onScanSuccess(code.trim(), null);
        }
    }

</script>

<style>
    .mode-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        border: none;
        border-radius: 24px;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.2s;
    }

    .mode-btn:active {
        transform: scale(0.98);
    }

    .mode-btn h2 {
        margin: 16px 0 8px 0;
    }

    .mode-btn p {
        margin: 0;
        color: #666;
    }

    .entry {
        border-bottom: 6px solid #10b981;
    }

    .exit {
        border-bottom: 6px solid #ef4444;
    }

    /* Override base container for full width feel on mobile */
    .container {
        padding: 16px;
    }
</style>
{% endblock %}