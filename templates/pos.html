{% extends "base.html" %}

{% block title %}Punto de Venta - StockApp{% endblock %}

{% block content %}
<div class="grid-dashboard" style="grid-template-columns: 2fr 1fr;">

    <!-- Left: Product Selection -->
    <div class="glass-card">
        <h2>Scanner / B√∫squeda</h2>
        <div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; align-items: center;">
            <!-- Quantity Selector -->
            <div
                style="display: flex; align-items: center; background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <button onclick="document.getElementById('pos-qty').stepDown()"
                    style="border:none; background:#f3f4f6; padding: 8px 12px; cursor: pointer;">-</button>
                <input type="number" id="pos-qty" value="1" min="1"
                    style="width: 50px; text-align: center; border:none; outline:none; font-weight: bold;">
                <button onclick="document.getElementById('pos-qty').stepUp()"
                    style="border:none; background:#f3f4f6; padding: 8px 12px; cursor: pointer;">+</button>
            </div>

            <!-- Manual Enter Button -->
            <button onclick="triggerSearch()" class="btn"
                style="height: 38px; padding: 0 16px; margin-right: 8px; background: #2563eb; color: white;">
                ‚èé
            </button>

            <input type="text" id="product-search" placeholder="Art√≠culo" autofocus
                style="margin-top: 0; flex: 1; min-width: 150px;">
            <button onclick="startScanner()" class="btn"
                style="padding: 12px 16px; font-size: 1rem; display: flex; align-items: center; gap: 8px; flex-shrink: 0; white-space: nowrap; background: #2563eb; color: white;">
                üì∑ Escanear
            </button>
        </div>

        <div id="product-results"
            style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
            <!-- Rendered via JS -->
        </div>
    </div>

    <!-- Right: Current Cart -->
    <div class="glass-card" style="display: flex; flex-direction: column; justify-content: space-between;">
        <!-- Removed redundant search bar -->

        <div class="glass-card" style="min-height: 400px; display: flex; flex-direction: column;">
            <div id="cart-items" style="flex: 1; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: white; border-bottom: 2px solid #eee;">
                        <tr>
                            <th style="text-align: left; padding: 8px;">Producto</th>
                            <th style="width: 50px; padding: 8px;">Cant</th>
                            <th style="text-align: right; padding: 8px;">Subtotal</th>
                            <th style="width: 30px;"></th>
                        </tr>
                    </thead>
                    <tbody id="cart-body">
                        <!-- Items injected by JS -->
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: #9ca3af;">
                                Escanea un producto o selecciona para comenzar
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 16px; margin-top: 16px;">
                <div
                    style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin-bottom: 16px;">
                    <span>Total</span>
                    <span id="cart-total">$0.00</span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <select id="client-select"
                        style="padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; background: white;">
                        <option value="">Cliente Casual</option>
                        <!-- Populated by JS -->
                    </select>
                    <button onclick="checkout()" class="btn" style="width: 100%; font-size: 1.2rem;">Cobrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; flex-direction: column;">
        <div style="background: white; padding: 16px; border-radius: 12px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 16px; text-align: center;">Escanear Producto</h3>
            <div id="reader" style="width: 100%;"></div>
            <button onclick="closeScanner()" class="btn"
                style="width: 100%; margin-top: 16px; background: #666;">Cerrar</button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: center;">
        <div
            style="background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <h2 style="margin-top: 0; color: var(--primary-color);">Confirmar Venta</h2>

            <div style="margin: 20px 0; font-size: 1.1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Total a Pagar:</span>
                    <strong id="modal-total-display">$0.00</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span>Cliente:</span>
                    <strong id="modal-client-display">Casual</strong>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="payment-method" style="display: block; margin-bottom: 8px; font-weight: bold;">M√©todo de
                    Pago:</label>
                <select id="payment-method"
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background: #fff; font-size: 1.1rem; margin-bottom: 15px;"
                    onchange="handlePaymentMethodChange()">
                    <option value="cash">Efectivo</option>
                    <option value="transfer">Transferencia</option>
                    <option value="account">Cuenta Corriente (Fiado)</option>
                </select>

                <label for="payment-amount" style="display: block; margin-bottom: 8px; font-weight: bold;">Monto
                    Abonado:</label>
                <div
                    style="display: flex; align-items: center; border: 1px solid #ccc; border-radius: 8px; padding: 0 12px; background: #f9fafb;">
                    <span style="font-weight: bold; color: #666;">$</span>
                    <input type="number" id="payment-amount" step="0.01"
                        style="width: 100%; padding: 12px; border: none; background: transparent; font-size: 1.2rem; outline: none;">
                </div>
                <small style="color: #666; display: block; margin-top: 4px;">Dejar vac√≠o o igual al total para pago
                    completo.</small>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="closePaymentModal()"
                    style="padding: 12px; border: 1px solid #ccc; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
                <button onclick="confirmCheckout()" class="btn" style="padding: 12px; font-weight: bold;">‚úÖ
                    Confirmar</button>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="/static/js/pos.js"></script>
    <script>
        // --- 1. ENTER KEY LOGIC (Search Bar) ---
        function triggerSearch() {
            const input = document.getElementById('product-search');
            input.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', which: 13, bubbles: true }));
            input.focus();
        }

        // --- 2. HYBRID SCANNER LOGIC (Google Native + Legacy Fallback) ---
        let html5QrcodeScanner = null;
        let nativeStream = null;
        let nativeInterval = null;

        async function startScanner() {
            const modal = document.getElementById('scanner-modal');
            modal.style.display = 'flex';
            const readerDiv = document.getElementById('reader');
            readerDiv.innerHTML = '<div style="padding:20px; text-align:center;">üîÑ Iniciando Esc√°ner...</div>';

            // A. CHECK FOR GOOGLE NATIVE BARCODE API (Chrome Android / ML Kit)
            if ('BarcodeDetector' in window) {
                console.log("üöÄ Usando Google Barcode Detection API (Nativo)");
                startNativeScanner(readerDiv);
            } else {
                console.log("‚ö†Ô∏è Google API no disponible. Usando librer√≠a Legacy (html5-qrcode).");
                startLegacyScanner();
            }
        }

        // --- OPTION A: GOOGLE NATIVE (SUPER FAST) ---
        async function startNativeScanner(container) {
            try {
                // 1. Setup Video Element (CENTERED & FIT)
                container.innerHTML = `
                    <div style="position: relative; width: 100%; height: 400px; background: black; display: flex; justify-content: center; align-items: center; overflow: hidden; border-radius: 12px;">
                        <video id="native-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
                        
                        <!-- HUD Overlay -->
                        <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px; z-index: 10;">
                            ‚ö° Google ML
                        </div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 30%; border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); pointer-events: none;"></div>
                    </div>
                    
                    <!-- "ENTER" / CLOSE BUTTON -->
                    <button onclick="closeScanner()" class="btn" style="width: 100%; margin-top: 16px; background: #10b981; color: white; padding: 16px; font-size: 1.2rem; font-weight: bold;">
                        ‚úÖ LISTO / CERRAR
                    </button>
                    <div style="text-align: center; margin-top: 8px; color: #666; font-size: 0.9rem;">Escanea m√∫ltiples productos seguidos</div>
                `;
                const video = document.getElementById('native-video');

                // 2. Get Camera Stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { exact: "environment" } }
                }).catch(() => navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }));

                nativeStream = stream;
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);

                // 3. Init Detector with robust formats
                const formats = ['ean_13', 'code_128', 'qr_code', 'ean_8', 'upc_a', 'upc_e', 'codabar', 'itf'];
                let barcodeDetector;
                try {
                    barcodeDetector = new BarcodeDetector({ formats: formats });
                } catch (e) {
                    console.warn("BarcodeDetector Init Failed (formats?), trying default:", e);
                    barcodeDetector = new BarcodeDetector(); // Try auto-detect
                }

                // 4. Scan Loop (Every 100ms)
                let frameCount = 0;
                const scanLoop = async () => {
                    if (!nativeStream) return; // Stop if closed
                    frameCount++;

                    try {
                        const barcodes = await barcodeDetector.detect(video);
                        if (barcodes.length > 0) {
                            const code = barcodes[0].rawValue;
                            console.log("üî´ Scanned (Native):", code);

                            // Visual Feedback Immediate
                            const feedback = document.createElement("div");
                            feedback.innerHTML = `‚úÖ ${code}`;
                            feedback.style.cssText = "position: absolute; top: 10px; right: 10px; background: #0f0; color: black; padding: 4px 8px; border-radius: 4px; font-weight:bold; z-index: 20;";
                            container.querySelector('div').appendChild(feedback); // Append to relative container
                            setTimeout(() => feedback.remove(), 1000);

                            onScanSuccess(code);
                            if (navigator.vibrate) navigator.vibrate(50);
                            await new Promise(r => setTimeout(r, 800)); // Debounce
                        }
                    } catch (e) {
                        // Silent fail on some frames is normal
                    }
                    if (nativeStream) requestAnimationFrame(scanLoop);
                };
                scanLoop();

            } catch (err) {
                console.error("Native Scanner failed:", err);
                container.innerHTML = `<div style="color:red; padding:20px;">Error c√°mara: ${err.message}</div>`;
                // Fallback to legacy if camera permission fails or other issue
                setTimeout(startLegacyScanner, 2000);
            }
        }

        // --- OPTION B: LEGACY (Compatible with iOS/Desktop) ---
        function startLegacyScanner() {
            if (html5QrcodeScanner === null) {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", {
                    fps: 10,
                    qrbox: { width: 250, height: 150 },
                    aspectRatio: 1.0
                }, false);
            }
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        }

        // --- COMMON SUCCESS HANDLER ---
        function onScanSuccess(decodedText) {
            // Logic to find product
            let scanned = decodedText.trim();
            // Cleanup prefixes
            if (scanned.startsWith(']C1')) scanned = scanned.substring(3);
            if (scanned.startsWith(']')) scanned = scanned.substring(scanned.indexOf(']') + 1);
            scanned = scanned.replace(/^\][A-Za-z]\d/, '');

            console.log("üîç Looking for:", scanned);

            // Access global products
            const product = allProducts.find(p =>
                (p.barcode && p.barcode.trim() === scanned) ||
                (p.item_number && p.item_number.toString().trim() === scanned)
            );

            // Fallback: Partial match
            let found = product;
            if (!found) {
                found = allProducts.find(p => {
                    const num = p.item_number ? p.item_number.toString().trim() : "";
                    return num.length >= 3 && scanned.startsWith(num);
                });
            }

            if (found) {
                addToCart(found);
                showScanFeedback(found.name, true);
            } else {
                showScanFeedback(`No encontrado: ${scanned}`, false);
            }
        }

        function showScanFeedback(text, isSuccess) {
            const feedback = document.createElement("div");
            feedback.innerText = isSuccess ? `‚úÖ ${text}` : `‚ùå ${text}`;
            feedback.style.cssText = `
                position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
                background: ${isSuccess ? '#10b981' : '#ef4444'}; color: white;
                padding: 10px 20px; border-radius: 8px; font-weight: bold; z-index: 1000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;
            const container = document.getElementById('native-video') ? document.getElementById('native-video').parentNode : document.getElementById('scanner-modal').querySelector('div');
            container.appendChild(feedback);
            setTimeout(() => feedback.remove(), 2000);
        }

        function onScanFailure(error) { }

        function closeScanner() {
            document.getElementById('scanner-modal').style.display = 'none';

            // Stop Native
            if (nativeStream) {
                nativeStream.getTracks().forEach(track => track.stop());
                nativeStream = null;
            }

            // Stop Legacy
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(e => console.error(e));
                html5QrcodeScanner = null;
            }
        }
    </script>
    {% endblock %}